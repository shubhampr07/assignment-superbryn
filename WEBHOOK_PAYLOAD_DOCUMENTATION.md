# LiveKit Webhook Payload Construction Documentation

## Overview

This document explains how different fields in the LiveKit webhook payload are constructed from within the LiveKit server environment. Understanding this is crucial for properly handling and processing webhook events.

## Webhook Event Flow

```
LiveKit Server → Event Trigger → Webhook Payload Construction → HTTP POST → Your Webhook Handler
```

## Webhook Payload Structure

### 1. `event` (String)

**Description**: Identifies the type of event that occurred.

**Construction Process**:
- Generated by LiveKit's internal event system
- Triggered when specific state changes occur in the server
- Event types are predefined in LiveKit's core event dispatcher

**Common Event Types**:
- `room_started` - When a room is created and becomes active
- `room_finished` - When a room is closed (empty timeout or manual close)
- `participant_joined` - When a participant successfully connects
- `participant_left` - When a participant disconnects
- `track_published` - When a participant publishes an audio/video track
- `track_unpublished` - When a track is removed
- `recording_started` - When recording begins
- `recording_finished` - When recording completes

**Example**:
```json
{
  "event": "participant_joined"
}
```

---

### 2. `room` (Object)

**Description**: Contains comprehensive information about the room where the event occurred.

**Construction Process**:
- Data is pulled from LiveKit's room state manager
- Room state is maintained in-memory (and optionally persisted) throughout the room's lifecycle
- Updated in real-time as participants join/leave and tracks are published/unpublished

**Fields**:

#### `room.sid` (String)
- **Source**: Generated when room is first created
- **Format**: Unique Session ID (e.g., "RM_AbCdEfGhIj")
- **Purpose**: Immutable identifier for this specific room session

#### `room.name` (String)
- **Source**: Provided by client/API when creating the room
- **Purpose**: Human-readable room identifier (can be reused after room closes)

#### `room.emptyTimeout` (Integer)
- **Source**: Configuration parameter from room creation
- **Purpose**: Seconds before empty room is automatically closed
- **Default**: Usually 300 seconds (5 minutes)

#### `room.maxParticipants` (Integer)
- **Source**: Configuration parameter from room creation
- **Purpose**: Maximum number of simultaneous participants allowed

#### `room.creationTime` (Integer - Unix timestamp)
- **Source**: Server's system time when room was created
- **Construction**: `time.Now().Unix()` at room initialization

#### `room.metadata` (String)
- **Source**: Custom data provided during room creation or updates
- **Purpose**: Store arbitrary JSON or string data about the room
- **Note**: Stored as-is, no validation by LiveKit

#### `room.numParticipants` (Integer)
- **Source**: Real-time count from room's participant registry
- **Updates**: Incremented on `participant_joined`, decremented on `participant_left`

#### `room.numPublishers` (Integer)
- **Source**: Count of participants currently publishing at least one track
- **Updates**: Recalculated when tracks are published/unpublished

#### `room.activeRecording` (Boolean)
- **Source**: Room's recording state flag
- **Updates**: Set when recording starts, cleared when recording stops

**Example**:
```json
{
  "room": {
    "sid": "RM_XYz789AbCdEf",
    "name": "voice-agent-room-123",
    "emptyTimeout": 300,
    "maxParticipants": 10,
    "creationTime": 1706284800,
    "metadata": "{\"purpose\":\"customer_support\",\"agent_id\":\"agent-42\"}",
    "numParticipants": 2,
    "numPublishers": 1,
    "activeRecording": false
  }
}
```

---

### 3. `participant` (Object)

**Description**: Information about the participant involved in the event (if applicable).

**Construction Process**:
- Created when participant establishes WebRTC connection
- Maintained in room's participant map
- Updated throughout participant's session

**Availability**: Only present in participant-related events (joined, left, metadata_changed, etc.)

**Fields**:

#### `participant.sid` (String)
- **Source**: Generated upon participant connection
- **Format**: Unique Session ID (e.g., "PA_123AbCdEfGh")
- **Lifecycle**: Valid only for this connection session

#### `participant.identity` (String)
- **Source**: Provided in access token or connection request
- **Purpose**: User-defined unique identifier (e.g., user_id, email)
- **Note**: Can be same across multiple sessions for the same user

#### `participant.name` (String)
- **Source**: Provided in access token (optional)
- **Purpose**: Display name for UI purposes

#### `participant.metadata` (String)
- **Source**: Custom data from token or API updates
- **Purpose**: Store arbitrary participant-specific data

#### `participant.joinedAt` (Integer - Unix timestamp)
- **Source**: Server's system time when participant connected
- **Construction**: `time.Now().Unix()` at connection establishment

#### `participant.state` (String)
- **Source**: Participant's connection state machine
- **Values**: `JOINING`, `JOINED`, `ACTIVE`, `DISCONNECTED`
- **Updates**: Changes based on WebRTC connection state

#### `participant.tracks` (Array)
- **Source**: Participant's published track registry
- **Contents**: Array of track objects (see Track section)

**Example**:
```json
{
  "participant": {
    "sid": "PA_XyZ123456",
    "identity": "user_42",
    "name": "John Doe",
    "metadata": "{\"role\":\"customer\",\"support_ticket\":\"TKT-123\"}",
    "joinedAt": 1706284850,
    "state": "ACTIVE",
    "tracks": []
  }
}
```

---

### 4. `track` (Object)

**Description**: Information about a media track (audio/video) involved in the event.

**Construction Process**:
- Created when participant publishes a track via WebRTC
- Registered in both participant and room track registries
- Updated when track state changes (mute/unmute)

**Availability**: Only present in track-related events (published, unpublished, muted, unmuted)

**Fields**:

#### `track.sid` (String)
- **Source**: Generated when track is published
- **Format**: Unique Session ID (e.g., "TR_AbCdEf123")

#### `track.type` (String)
- **Source**: WebRTC track type from media stream
- **Values**: `AUDIO`, `VIDEO`, `DATA`

#### `track.name` (String)
- **Source**: Track label from client publishing request
- **Common names**: "microphone", "camera", "screen"

#### `track.muted` (Boolean)
- **Source**: Track's mute state flag
- **Updates**: Set/cleared by participant or server actions

#### `track.source` (String)
- **Source**: Semantic meaning of the track
- **Values**: `CAMERA`, `MICROPHONE`, `SCREEN_SHARE`, `SCREEN_SHARE_AUDIO`
- **Purpose**: Helps clients render appropriate UI

**Example**:
```json
{
  "track": {
    "sid": "TR_Mic789XyZ",
    "type": "AUDIO",
    "name": "microphone",
    "muted": false,
    "source": "MICROPHONE"
  }
}
```

---

### 5. `createdAt` (Integer - Unix timestamp)

**Description**: When the webhook event was created.

**Construction Process**:
- Captured at the moment the event is generated
- Uses server's system time: `time.Now().Unix()`
- Represents when the event occurred, not when webhook was delivered

**Purpose**: 
- Event sequencing
- Debugging timing issues
- Calculating latencies

**Example**:
```json
{
  "createdAt": 1706284900
}
```

---

### 6. `id` (String)

**Description**: Unique identifier for this specific webhook delivery.

**Construction Process**:
- Generated by LiveKit's webhook dispatcher
- Typically a UUID v4
- Created per webhook delivery attempt (same event may have different IDs if retried)

**Purpose**:
- Idempotency - detect duplicate deliveries
- Debugging webhook delivery issues
- Tracking retry attempts

**Example**:
```json
{
  "id": "AW_550e8400-e29b-41d4-a716-446655440000"
}
```

---

## Complete Webhook Example

Here's a real-world example of a complete webhook payload for a `participant_joined` event:

```json
{
  "id": "AW_7b3f2c1a-8d4e-4f5a-9b2c-1e3f4a5b6c7d",
  "event": "participant_joined",
  "createdAt": 1706284900,
  "room": {
    "sid": "RM_VoiceAgent123",
    "name": "customer-support-room-456",
    "emptyTimeout": 300,
    "maxParticipants": 10,
    "creationTime": 1706284850,
    "metadata": "{\"agent_type\":\"voice\",\"language\":\"en\"}",
    "numParticipants": 2,
    "numPublishers": 1,
    "activeRecording": true
  },
  "participant": {
    "sid": "PA_Customer789",
    "identity": "customer_user_42",
    "name": "Jane Smith",
    "metadata": "{\"customer_id\":\"CUST-42\",\"tier\":\"premium\"}",
    "joinedAt": 1706284900,
    "state": "ACTIVE",
    "tracks": [
      {
        "sid": "TR_AudioMic456",
        "type": "AUDIO",
        "name": "microphone",
        "muted": false,
        "source": "MICROPHONE"
      }
    ]
  }
}
```

---

## Webhook Security

### Signature Verification

**Construction Process**:
1. LiveKit takes the raw webhook payload (JSON string)
2. Computes HMAC-SHA256 using the webhook secret: `HMAC-SHA256(secret, payload)`
3. Sends signature in `X-LiveKit-Signature` header

**Verification in Handler**:
```python
def verify_webhook_signature(payload: bytes, signature: str) -> bool:
    expected = hmac.new(
        WEBHOOK_SECRET.encode(),
        payload,
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(expected, signature)
```

---

## Key Takeaways

1. **All IDs are Generated Server-Side**: SIDs for rooms, participants, and tracks are created by LiveKit's ID generator, not provided by clients.

2. **Timestamps Use Unix Epoch**: All time values are in seconds since Unix epoch (January 1, 1970).

3. **Metadata is Opaque**: LiveKit doesn't parse or validate metadata fields - it's your responsibility to structure and parse them.

4. **State is Real-Time**: Counts like `numParticipants` reflect the current state at the moment the webhook is generated.

5. **Event-Specific Fields**: Not all fields are present in all webhooks - check event type first.

6. **Webhook Delivery is Asynchronous**: There may be a small delay between the event occurring and the webhook being received.

---

## Using with livekit-evals

The `livekit-evals` package can consume these webhook payloads to:
- Track conversation metrics
- Measure agent response times
- Calculate participant engagement
- Monitor audio quality
- Generate performance reports

Example integration:
```python
from livekit_evals import CallEvaluator

evaluator = CallEvaluator()

@app.route("/webhook", methods=["POST"])
def handle_webhook():
    webhook_data = request.json
    
    # Feed to evaluator
    evaluator.process_event(webhook_data)
    
    # Get metrics
    if webhook_data["event"] == "room_finished":
        metrics = evaluator.get_metrics(webhook_data["room"]["sid"])
        print(f"Call duration: {metrics.duration}s")
        print(f"Agent responses: {metrics.agent_response_count}")
```

---

## References

- [LiveKit Webhooks Documentation](https://docs.livekit.io/guides/webhooks/)
- [LiveKit Server SDK](https://github.com/livekit/server-sdk-python)
- [livekit-evals Package](https://pypi.org/project/livekit-evals/)

---

**Document Version**: 1.0  
**Last Updated**: January 2026  
**Author**: LiveKit Integration Team
